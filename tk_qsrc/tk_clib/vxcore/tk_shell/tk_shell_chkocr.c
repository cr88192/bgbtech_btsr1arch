u64 tk_gfxcon_glyphs[128];

u64 tk_chksane_ocr_nl0[128];
u64 tk_chksane_ocr_nl1[64];
u64 tk_chksane_ocr_nlf[10];

int tk_chksane_ocr_eval(u64 pix)
{
	u16 dbx[32];
	u64 *nl0;
	u64 *nl1;
	u64 *nlf;
	u64 j0, j1, j2, j3, j0b, j1b;
	int i, j, k;
	
	nl0=tk_chksane_ocr_nl0;
	nl1=tk_chksane_ocr_nl1;
	nlf=tk_chksane_ocr_nlf;

	j0=__int_pmortq(pix>>32, pix);
	j1=__int_pmortq(j0>>32, j0);

	dbx[0]=j1>> 0;
	dbx[1]=j1>> 8;
	dbx[2]=j1>>16;
	dbx[3]=j1>>24;
	dbx[4]=j1>>32;
	dbx[5]=j1>>40;
	dbx[6]=j1>>48;
	dbx[7]=(j1>>56) | (j1<<8);

	for(i=0; i<8; i++)
		dbx[i+8]=dbx[i];

	j0=0;
	j0b=0;
	for(i=0; i<128; i++)
	{
		j0b=(j0b<<1)|(j0>>63);
		j0=__bitnn(j0, dbx[i&15], nl0[i]);
	}

	j1=0;
	j1b=0;

	for(i=0; i<64; i++)
	{
		j1b=(j1b<<1)|(j1>>63);

		j3=	((j0 >>((i&7)*8))<<0) |
			((j0b>>((i&7)*8))<<8) ;
		j1=__bitnn(j1, j3, nl1[i]);
	}

	k=0;
	for(i=0; i<10; i++)
	{
		k=__bitnn(k, j1>>(i*6), nlf[i]);
	}

	return(k);
}

int tk_chksane_initocr()
{
	u64 *nl0;
	u64 *nl1;
	u64 *nlf;
	
	nl0=tk_chksane_ocr_nl0;
	nl1=tk_chksane_ocr_nl1;
	nlf=tk_chksane_ocr_nlf;

	nl0[0]=0x00B0345DEAA34F6DULL;
	nl0[1]=0x000440799AAAFDA9ULL;
	nl0[2]=0x00C104B5BC5AE544ULL;
	nl0[3]=0x0062E4FBA15C5154ULL;
	nl0[4]=0x00843786DFF27EABULL;
	nl0[5]=0x00EAD0437323BE24ULL;
	nl0[6]=0x00057580BE75187FULL;
	nl0[7]=0x00DBD4ADB67D7A78ULL;
	nl0[8]=0x00DB961D65A65AE5ULL;
	nl0[9]=0x009AA07768C0E194ULL;
	nl0[10]=0x00BD48EFE4789BA4ULL;
	nl0[11]=0x00F94D5CFCC17D51ULL;
	nl0[12]=0x005B05896136E986ULL;
	nl0[13]=0x0045A423616ACECDULL;
	nl0[14]=0x00C4F9013C52E58FULL;
	nl0[15]=0x00C0C94A3891F961ULL;
	nl0[16]=0x00E9B4C2EB030E68ULL;
	nl0[17]=0x00C4F2AFF0DABC13ULL;
	nl0[18]=0x006EBCD5973D5FB5ULL;
	nl0[19]=0x009FB8723D9081C9ULL;
	nl0[20]=0x000263347AB53A4AULL;
	nl0[21]=0x006D50629CB9A40AULL;
	nl0[22]=0x00F4B305008943C9ULL;
	nl0[23]=0x0044B4C4481289EFULL;
	nl0[24]=0x00CA2D7B68D139DEULL;
	nl0[25]=0x00FF02BEB854F4A1ULL;
	nl0[26]=0x0014D18757A24EC1ULL;
	nl0[27]=0x00C16B773D0A2929ULL;
	nl0[28]=0x002D06269088BB8CULL;
	nl0[29]=0x00613B2CD552A2B7ULL;
	nl0[30]=0x00B9E0E56B262D70ULL;
	nl0[31]=0x0035F77E96DC224BULL;
	nl0[32]=0x001EE234DEE1595BULL;
	nl0[33]=0x0027E0FF1FE5E29DULL;
	nl0[34]=0x00F9C931A5E43BD8ULL;
	nl0[35]=0x002F428D70459739ULL;
	nl0[36]=0x00C2CA9CFADE9145ULL;
	nl0[37]=0x00606E2BAD0E114DULL;
	nl0[38]=0x00B0AF86E16AFD0AULL;
	nl0[39]=0x0084388035C92BD8ULL;
	nl0[40]=0x004C8F0B8757D388ULL;
	nl0[41]=0x000D4767F55074A9ULL;
	nl0[42]=0x00ED5B79FBFA2B89ULL;
	nl0[43]=0x00E98279A5EE0266ULL;
	nl0[44]=0x004AC8EF0C43A6E7ULL;
	nl0[45]=0x00FB08DAA4E03EB1ULL;
	nl0[46]=0x001C065395B565F1ULL;
	nl0[47]=0x005433361472FA8AULL;
	nl0[48]=0x005DFE0CFE9C31B8ULL;
	nl0[49]=0x006C472304EA7329ULL;
	nl0[50]=0x00C78BD258500814ULL;
	nl0[51]=0x00AA669C42A3C969ULL;
	nl0[52]=0x009DD6201BD6E2C0ULL;
	nl0[53]=0x00F0E6774860C987ULL;
	nl0[54]=0x002A8C3A1E03E2EAULL;
	nl0[55]=0x00DA2490E2F4B82FULL;
	nl0[56]=0x007511DEF5FD0AA2ULL;
	nl0[57]=0x00E9DADA66E8883EULL;
	nl0[58]=0x009F337443913711ULL;
	nl0[59]=0x008EF25507193222ULL;
	nl0[60]=0x009F05900E7FF720ULL;
	nl0[61]=0x009703A0849EBBA7ULL;
	nl0[62]=0x00D34DD27F15EC88ULL;
	nl0[63]=0x00D7989CEBE8C10DULL;
	nl0[64]=0x00DE300A4FD37714ULL;
	nl0[65]=0x0012D1746EB4D668ULL;
	nl0[66]=0x006C2BAE53AA4203ULL;
	nl0[67]=0x00148BA8D1EBC096ULL;
	nl0[68]=0x00EEC3D14B3C0D46ULL;
	nl0[69]=0x0010BFD90C4C0132ULL;
	nl0[70]=0x00700EB68A993FDCULL;
	nl0[71]=0x006FDF528BF54925ULL;
	nl0[72]=0x00AB6C6A0F429698ULL;
	nl0[73]=0x00913FE276165CB7ULL;
	nl0[74]=0x0093A90BE0BC44DCULL;
	nl0[75]=0x006D7914B043A950ULL;
	nl0[76]=0x00B701CE36FF0E62ULL;
	nl0[77]=0x007227A5CF1A3D1DULL;
	nl0[78]=0x00C4E5F0747E6D5DULL;
	nl0[79]=0x009505D11238D585ULL;
	nl0[80]=0x00AE0DA8080C7376ULL;
	nl0[81]=0x00DA46805714F5AEULL;
	nl0[82]=0x00A40A83E46197A8ULL;
	nl0[83]=0x008EEFFB170AE72EULL;
	nl0[84]=0x00653B406ACD8D7EULL;
	nl0[85]=0x00ECEF2DEA798E85ULL;
	nl0[86]=0x000151DE4AAC5C2CULL;
	nl0[87]=0x00EB7AE4AB7AB521ULL;
	nl0[88]=0x0082E5A04D223BFBULL;
	nl0[89]=0x0086A6D6490BF506ULL;
	nl0[90]=0x00FECF2B07FF91EEULL;
	nl0[91]=0x00F2B4482DEA304AULL;
	nl0[92]=0x0031E970482AFB22ULL;
	nl0[93]=0x00C996701E833F2CULL;
	nl0[94]=0x00A124FA0A66B190ULL;
	nl0[95]=0x00A23B59CE1DEECDULL;
	nl0[96]=0x00AD9575E5E9E31CULL;
	nl0[97]=0x0015B20F9C129B64ULL;
	nl0[98]=0x009221E38EDDBD11ULL;
	nl0[99]=0x00B8CB38E29078E9ULL;
	nl0[100]=0x0046A8AC601AD741ULL;
	nl0[101]=0x00DB4FF52C6B46D4ULL;
	nl0[102]=0x00C84178A2BCBD36ULL;
	nl0[103]=0x00B528D2AE6F5FCFULL;
	nl0[104]=0x000D5ECADC39682DULL;
	nl0[105]=0x0078BAE4336F51B8ULL;
	nl0[106]=0x000206AEE5D53075ULL;
	nl0[107]=0x00DD32E8EE22F737ULL;
	nl0[108]=0x007E092586F63BFCULL;
	nl0[109]=0x00782198A3BB89D9ULL;
	nl0[110]=0x004317BED94E9B16ULL;
	nl0[111]=0x00C2AE7B525BC1A2ULL;
	nl0[112]=0x00276A1D2427B931ULL;
	nl0[113]=0x00145C22B79FF26AULL;
	nl0[114]=0x000F6FDE6C2DC2E4ULL;
	nl0[115]=0x00B2969B477424F9ULL;
	nl0[116]=0x006CAD9259ACA76CULL;
	nl0[117]=0x007A68AFAE198582ULL;
	nl0[118]=0x00EBB4F9CC98E1B4ULL;
	nl0[119]=0x0067EA88825CBCA6ULL;
	nl0[120]=0x00437DBCDCAF5EE3ULL;
	nl0[121]=0x001904C4E05A40BBULL;
	nl0[122]=0x0088CE3A0AB4CC5FULL;
	nl0[123]=0x0060B807A0FCA125ULL;
	nl0[124]=0x0047B35A356F7BC6ULL;
	nl0[125]=0x00B3AF6BBA5262A6ULL;
	nl0[126]=0x002A32726DA02744ULL;
	nl0[127]=0x0043F3A317A50A72ULL;
	nl1[0]=0x00006000CB741022ULL;
	nl1[1]=0x0000200000000010ULL;
	nl1[2]=0x0000801004800884ULL;
	nl1[3]=0x000026000F000268ULL;
	nl1[4]=0x0030043040200A18ULL;
	nl1[5]=0x0006040000210018ULL;
	nl1[6]=0x000080000488C0E0ULL;
	nl1[7]=0x0000600000440004ULL;
	nl1[8]=0x0028009082000004ULL;
	nl1[9]=0x0000618274024000ULL;
	nl1[10]=0x00186C0680000000ULL;
	nl1[11]=0x00C00104001000E0ULL;
	nl1[12]=0x00000010000C0000ULL;
	nl1[13]=0x0000830A00120200ULL;
	nl1[14]=0x0000080000000800ULL;
	nl1[15]=0x00004000D8800100ULL;
	nl1[16]=0x0000200200000203ULL;
	nl1[17]=0x0000040000000212ULL;
	nl1[18]=0x00006000D8000899ULL;
	nl1[19]=0x000A000000000402ULL;
	nl1[20]=0x0000000240103000ULL;
	nl1[21]=0x00001001010306C0ULL;
	nl1[22]=0x0030603800098CC0ULL;
	nl1[23]=0x00002C0600600020ULL;
	nl1[24]=0x00010000C6040004ULL;
	nl1[25]=0x0000004010100000ULL;
	nl1[26]=0x0000200084100021ULL;
	nl1[27]=0x0030800404000808ULL;
	nl1[28]=0x0003202108243003ULL;
	nl1[29]=0x0006010000000900ULL;
	nl1[30]=0x000C8986000000C0ULL;
	nl1[31]=0x0000420000000000ULL;
	nl1[32]=0x000C138298709002ULL;
	nl1[33]=0x0000A000000006D4ULL;
	nl1[34]=0x00010080000210C0ULL;
	nl1[35]=0x0030000800045400ULL;
	nl1[36]=0x0063018008202000ULL;
	nl1[37]=0x000000400100001AULL;
	nl1[38]=0x0000000800080600ULL;
	nl1[39]=0x0000000603441000ULL;
	nl1[40]=0x0006600042200205ULL;
	nl1[41]=0x00002000100C0200ULL;
	nl1[42]=0x0000040080044000ULL;
	nl1[43]=0x000A900400008120ULL;
	nl1[44]=0x000000200210001CULL;
	nl1[45]=0x0000218200800000ULL;
	nl1[46]=0x0000080021003040ULL;
	nl1[47]=0x00C0440040000100ULL;
	nl1[48]=0x000F600820610602ULL;
	nl1[49]=0x0000804000108010ULL;
	nl1[50]=0x0000001000000080ULL;
	nl1[51]=0x0000000200000407ULL;
	nl1[52]=0x0000000001602100ULL;
	nl1[53]=0x00E90C000060B058ULL;
	nl1[54]=0x0000000000281060ULL;
	nl1[55]=0x0000000000408000ULL;
	nl1[56]=0x0000000102C18000ULL;
	nl1[57]=0x0000000018E1C000ULL;
	nl1[58]=0x000001B0C0000000ULL;
	nl1[59]=0x0060638C00600000ULL;
	nl1[60]=0x0000602000000808ULL;
	nl1[61]=0x0001010007000009ULL;
	nl1[62]=0x0000080000000001ULL;
	nl1[63]=0x0001400000000644ULL;
	nlf[0]=0x00F075ABB621495BULL;
	nlf[1]=0x00FDDF9F8468B4F1ULL;
	nlf[2]=0x008035F0DD2C467BULL;
	nlf[3]=0x0009AB2DB9E7ABD5ULL;
	nlf[4]=0x00852CA38A193A8BULL;
	nlf[5]=0x00FEB520D4701EE1ULL;
	nlf[6]=0x000E709FF9773368ULL;
	nlf[7]=0x007542F5DA65B7ACULL;
	nlf[8]=0x0082E0EDE5D96CDDULL;
	nlf[9]=0x00014D6892A46473ULL;
}

int tk_chksane_chkocr()
{
	int i, j, k;

	tk_chksane_initocr();
	
	for(i=0; i<10; i++)
	{
		j=tk_chksane_ocr_eval(tk_gfxcon_glyphs['0'+i]);
		printf("tk_chksane_chkocr: Dig=%d Got=%03X Expect=%03X\n", i, j, 1<<i);
	}
}
